# pi2mqtt

This tool monitors sensors connected to the Raspberry Pi and sends the data to a
broker via mqtt protocol.  The current sensors include:
## Temp - Thermistor
You can connect multiple thermistors to an A/D card connected to the Raspberry Pi.  The typical circuit is to have the NTN Thermistor connected to an analog input with a pull down resistor to ground and the Thermistor connected to the pin and to Vdd.  

To enable, the implementation that was validated uses a ADS1115 A/D card attached to the Pi.
## Temp -  DS18B20
You can connect multiple DS18B20 sensors to pin 4 of the rpi.  Be sure to include 
a 4.7Kohm pull up.  The tools will scan for devices in the `/sys/bus/w1/devices` directory.  DS18B20 devices will have the prefix of _28-\*_.
	
For the sensor kernel module to be enabled, include the following line in the `/boot/config.txt` file
```
	dtoverlay=w1-gpio
```
Edit the file and include the above line, then reboot, and the device should be visible
## Electric Demand - RAVEn
The **Rainforest RAVEn** device connect to the USB port on the rpi and can be used 
to read a smart electric meter in the home.  Currently, this works with San Diego Gas and Electric Meters to the best of the authors knowledge.
## Door Switch
This can be any digital signal on a pin that is either high or low.  Currently used for a magnetic Reed switch on a door.  The tool reads the digital pin using the **wiringPi** package numbering scheme.  You will need to add the pin number to your configuration file.
## Usage
```
    $ pi2mqtt [-v] [-c FILE]
    -v - verbose mode.
    -c - configuration file (default is template.conf)
```

## Installation
To build and install the tools you will need to install the autotools suite.  For ubuntu:
```
    $ sudo apt-get update
    $ sudo apt-get install autotools-dev
```
**pi2mqtt** depends on the following libraries
* [wiringPi](http://wiringpi.com) (http://wiringpi.com)
* [paho-mqtt3](http://www.eclipse.org/paho/clients/c) (http://www.eclipse.org/paho/clients/c)
* [confuse](https://github.com/martinh/libconfuse) (https://github.com/martinh/libconfuse)


###Installing Using GIT:
```
$ git clone https://github.com/ngongca/pi2mqtt.git
$ autoreconf -i
$ ./configure
$ ./init_pi2mqtt

<Edit the configuration file>

$ make
$ sudo make install
```
Setting up for auto initialization
```
$ sudo cp pi2mqtt.sh /etc/init.d/pi2mqtt
$ sudo chmod +x /etc/init.d/pi2mqtt
$ sudo update-rc.d pi2mqtt defaults
```
## Configuration
`./init_pi2mqtt` generates a template configuration file, ___pi2mqtt.conf___ , that will need to be edited for your configuration.  It uses the **confuse** libary syntax. Below is the syntax for the various types of sensors.
### Manditory fields
Home topic for all mqtt topics.  In this case it will be an autogenerated ID using the PI Serial number.
```
home = <id>
```
client ID for the mqtt sensor controller (usually the microcontroller id such as the PI  THIS MUST BE A UNIQUE identifier)
```
clientid = <id>
```
mqtt broker address
```
mqttbrokeraddress = "<address>"
```
mqtt broker user id if the broker requires a user authentication
```
mqttbrokeruid = "<user id>"
```
mqtt broker user id password
```
mqttbrokerpwd = "<password>"
```
topic for the sensor controller's management port. This will be monitored to provide management messages back to the controller.  It is autogenerated to use the PI home topic.
```
mqttsubtopic = "<topic>"
```
### Thermistor Temp Sensor syntax
<> indicates user input.  Leading spaces are required. Multiple sensors are allowed as long as there is a unique identifer
```
tempsensor <identifier> {
 pin = "<wiring pi pin for A/D>"
 A = "<Stienman-Hart coefficient>"
 B = "<Stienman-Hart coefficient>"
 C = "<Stienman-Hart coefficient>"
 Rb = "<bias resister value (fp) pulldown to ground>"
 location = "<location of sensor used in topic>"
 mqttpubtopic = "<topic to publish>"
 sampletime = <integer in seconds>
}

Example:

tempsensor nistthermistor1 {
 pin = 2
 A = "1.413e-03"
 B = "2.385e-04"
 C = "9.588e-08"
 Rb = 0.0
 location = "freezer1"
 mqttpubtopic = "tempsensor"
 sampletime = 60
}

```
### DS18B20 config syntax
<> indicates user input.  Leading spaces are required
```
ds18b20 <identifier> {
 address = "<fully qualified directory to device>"
 mqttpubtopic = "<topic to publish>"
 sampletime = <integer in seconds>
 isfahrenheit = <1 if is, 0 if Celsius desired>
}

Example:

ds18b20 ds18b20_0 {
 address = "/sys/bus/w1/devices/28-0516a49946ff"
 mqttpubtopic = "temp"
 location = "server"
 sampletime = 4
 isfahrenheit = 1
}
```
### Switch config syntax
<> indicates user input.  Leading spaces are required
```
doorswitch <identifier> {
 pin = <wiringPi pin number>
 mqttpubtopic = "<topic to publish>"
 location = "<string location of sensor (no spaces)>"
 sampletime = <time in seconds>
}

Example:

doorswitch door1 {
 pin = 1
 mqttpubtopic = "door"
 location = "garageleft"
 sampletime = 10
}
```
### RAVEn config syntax 
<> indicates user input.  Leading spaces are required
```
RAVEn <identifier> {
 address = "<location of the serial port>"
 location = "<text>"
 mqttpubtopic = "<topic to publish>"
}

Example:

RAVEn raven0 {
 address = "/dev/ttyUSB0"
 location = "garage"
 mqttpubtopic = "demand"
}

```






